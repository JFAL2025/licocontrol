{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Productos - LicoControl</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <div class="container">
        <!-- Sidebar Elegante -->
        <div class="sidebar">
            <div class="logo">
                <h1>LicoControl</h1>
                <p>Licorería "El Cruce"</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item" data-module="dashboard">
                    <i class="fas fa-chart-line"></i> Dashboard
                </li>
                <li class="nav-item" data-module="inventory">
                    <i class="fas fa-boxes"></i> Inventario
                </li>
                <li class="nav-item" data-module="sales">
                    <i class="fas fa-cash-register"></i> Ventas
                </li>
                <li class="nav-item" data-module="reports">
                    <i class="fas fa-chart-bar"></i> Reportes
                </li>
                <li class="nav-item active" data-module="products">
                    <i class="fas fa-wine-bottle"></i> Productos
                </li>
            </ul>
        </div>
        
        <!-- Main Content Elegante -->
        <div class="main-content">
            <div class="header">
                <h2>Catálogo de Productos</h2>
                <div class="user-info">
                    <span>Administrador - Licorería "El Cruce"</span>
                    <div class="user-avatar">A</div>
                </div>
            </div>
            
            <!-- Módulo: Catálogo de Productos -->
            <div class="module-section active">
                <!-- Barra de Herramientas Mejorada -->
                <div class="toolbar">
                    <div class="toolbar-left">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-product" placeholder="Buscar por nombre, código o marca...">
                        </div>
                        <div class="quick-stats">
                            <span class="stat-badge">
                                <i class="fas fa-wine-bottle"></i>
                                <span id="total-products">12</span> Productos
                            </span>
                            <span class="stat-badge warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span id="low-stock-count">3</span> Stock Bajo
                            </span>
                        </div>
                    </div>
                    <div class="toolbar-buttons">
                        <button class="btn btn-primary" id="btn-nuevo-producto">
                            <i class="fas fa-plus-circle"></i> Nuevo Producto
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="btn-importar">
                                <i class="fas fa-file-import"></i> Importar
                            </button>
                            <button class="btn btn-secondary" id="btn-exportar">
                                <i class="fas fa-file-export"></i> Exportar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panel de Filtros Avanzados -->
                <div class="filters-panel">
                    <div class="filters-header">
                        <h4><i class="fas fa-filter"></i> Filtros Avanzados</h4>
                        <button class="btn btn-link" id="toggle-filters">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="filters-content" id="filters-content">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Categoría</label>
                                <div class="category-filters">
                                    <button class="category-filter active" data-category="">Todas</button>
                                    <button class="category-filter" data-category="whisky">
                                        <i class="fas fa-wine-bottle"></i> Whisky
                                    </button>
                                    <button class="category-filter" data-category="vino">
                                        <i class="fas fa-wine-glass-alt"></i> Vino
                                    </button>
                                    <button class="category-filter" data-category="vodka">
                                        <i class="fas fa-cocktail"></i> Vodka
                                    </button>
                                    <button class="category-filter" data-category="ron">
                                        <i class="fas fa-glass-whiskey"></i> Ron
                                    </button>
                                    <button class="category-filter" data-category="cerveza">
                                        <i class="fas fa-beer"></i> Cerveza
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Estado de Stock</label>
                                <select class="filter-select" id="filter-status">
                                    <option value="">Todos los estados</option>
                                    <option value="in-stock">En Stock</option>
                                    <option value="low-stock">Stock Bajo</option>
                                    <option value="out-of-stock">Sin Stock</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Ordenar por</label>
                                <select class="filter-select" id="filter-sort">
                                    <option value="name">Nombre A-Z</option>
                                    <option value="name-desc">Nombre Z-A</option>
                                    <option value="price">Precio (Menor a Mayor)</option>
                                    <option value="price-desc">Precio (Mayor a Menor)</option>
                                    <option value="stock">Stock (Menor a Mayor)</option>
                                    <option value="stock-desc">Stock (Mayor a Menor)</option>
                                    <option value="margin">Margen (%)</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Rango de Precio</label>
                                <div class="price-range">
                                    <input type="number" class="form-control-sm" id="price-min" placeholder="Mín" min="0">
                                    <span>-</span>
                                    <input type="number" class="form-control-sm" id="price-max" placeholder="Máx" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Tarjetas de Productos Mejorada -->
                <div class="products-grid" id="view-grid">
                    <!-- Los productos se cargarán dinámicamente -->
                </div>

                <!-- Vista de Tabla Mejorada -->
                <div class="table-container" id="view-table" style="display: none;">
                    <div class="table-responsive">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="select-all">
                                    </th>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Precio Compra</th>
                                    <th>Precio Venta</th>
                                    <th>Margen</th>
                                    <th>Stock</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Los productos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Controles de Vista y Paginación -->
                <div class="view-controls">
                    <div class="view-options">
                        <span>Vista:</span>
                        <button class="btn-view active" data-view="grid">
                            <i class="fas fa-th-large"></i> Grid
                        </button>
                        <button class="btn-view" data-view="table">
                            <i class="fas fa-list"></i> Lista
                        </button>
                    </div>
                    <div class="pagination">
                        <span class="pagination-info">Mostrando <span id="showing-count">6</span> de <span id="total-count">12</span> productos</span>
                        <div class="pagination-controls">
                            <button class="btn-pagination" id="prev-page">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="page-info">Página <span id="current-page">1</span> de <span id="total-pages">2</span></span>
                            <button class="btn-pagination" id="next-page">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Formulario para Nuevo/Editar Producto Mejorado -->
                <div class="modal" id="product-modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="form-title">Registrar Nuevo Producto</h3>
                            <button class="btn-close" id="btn-cancelar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="form-producto-data">
                                <div class="form-tabs">
                                    <button type="button" class="tab-btn active" data-tab="basic">Información Básica</button>
                                    <button type="button" class="tab-btn" data-tab="pricing">Precios y Stock</button>
                                    <button type="button" class="tab-btn" data-tab="additional">Información Adicional</button>
                                </div>
                                
                                <div class="tab-content active" id="tab-basic">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="product-name">Nombre del Producto *</label>
                                            <input type="text" class="form-control" id="product-name" name="nombre" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="product-category">Categoría *</label>
                                            <select class="form-control" id="product-category" name="categoria" required>
                                                <option value="">Seleccione categoría</option>
                                                <option value="whisky">Whisky</option>
                                                <option value="vino">Vino</option>
                                                <option value="vodka">Vodka</option>
                                                <option value="ron">Ron</option>
                                                <option value="cerveza">Cerveza</option>
                                                <option value="tequila">Tequila</option>
                                                <option value="licor">Licor</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="product-code">Código de Barras</label>
                                            <input type="text" class="form-control" id="product-code" name="codigo_barras" placeholder="Opcional">
                                        </div>
                                        <div class="form-group">
                                            <label for="product-brand">Marca</label>
                                            <input type="text" class="form-control" id="product-brand" name="marca" placeholder="Opcional">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-content" id="tab-pricing">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="product-cost">Precio de Costo *</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="product-cost" name="precio_costo" min="0" step="0.01" required>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="product-price">Precio de Venta *</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="product-price" name="precio_venta" min="0" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="product-stock">Stock Inicial *</label>
                                            <input type="number" class="form-control" id="product-stock" name="stock" min="0" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="product-min-stock">Stock Mínimo *</label>
                                            <input type="number" class="form-control" id="product-min-stock" name="stock_minimo" min="1" required>
                                        </div>
                                    </div>
                                    <div class="margin-preview">
                                        <div class="margin-info">
                                            <span>Margen Calculado:</span>
                                            <strong id="margin-preview">0%</strong>
                                        </div>
                                        <div class="profit-info">
                                            <span>Ganancia por Unidad:</span>
                                            <strong id="profit-preview">$0</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-content" id="tab-additional">
                                    <div class="form-group">
                                        <label for="product-description">Descripción del Producto</label>
                                        <textarea class="form-control" id="product-description" name="descripcion" rows="4" placeholder="Describe las características del producto..."></textarea>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="product-supplier">Proveedor</label>
                                            <input type="text" class="form-control" id="product-supplier" name="proveedor" placeholder="Opcional">
                                        </div>
                                        <div class="form-group">
                                            <label for="product-location">Ubicación en Tienda</label>
                                            <input type="text" class="form-control" id="product-location" name="ubicacion" placeholder="Ej: Estante A, Nivel 2">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-buttons">
                                    <button type="button" class="btn btn-secondary" id="btn-prev-tab" style="display: none;">
                                        <i class="fas fa-arrow-left"></i> Anterior
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btn-next-tab">
                                        Siguiente <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button type="submit" class="btn btn-success" id="btn-submit" style="display: none;">
                                        <i class="fas fa-save"></i> Guardar Producto
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base de datos de productos de ejemplo
        const productosEjemplo = [
            {
                id: 1,
                nombre: "Whisky Johnnie Walker Red Label",
                categoria: "whisky",
                codigo_barras: "7501030215002",
                marca: "Johnnie Walker",
                precio_costo: 30000,
                precio_venta: 50000,
                stock: 5,
                stock_minimo: 10,
                descripcion: "Whisky escocés blend, sabor suave y accesible",
                proveedor: "Diageo Colombia",
                ubicacion: "Estante A1"
            },
            {
                id: 2,
                nombre: "Vino Casillero del Diablo Cabernet",
                categoria: "vino",
                codigo_barras: "7804320752614",
                marca: "Concha y Toro",
                precio_costo: 17500,
                precio_venta: 25000,
                stock: 8,
                stock_minimo: 15,
                descripcion: "Vino tinto chileno, cuerpo medio, taninos suaves",
                proveedor: "Vinos Internacionales",
                ubicacion: "Estante B2"
            },
            {
                id: 3,
                nombre: "Vodka Absolut",
                categoria: "vodka",
                codigo_barras: "7312040017070",
                marca: "Absolut",
                precio_costo: 18000,
                precio_venta: 30000,
                stock: 3,
                stock_minimo: 8,
                descripcion: "Vodka sueco premium, destilado continuo",
                proveedor: "Pernod Ricard",
                ubicacion: "Estante C3"
            },
            {
                id: 4,
                nombre: "Ron Viejo de Caldas 8 años",
                categoria: "ron",
                codigo_barras: "7702014001927",
                marca: "Viejo de Caldas",
                precio_costo: 20000,
                precio_venta: 28000,
                stock: 25,
                stock_minimo: 12,
                descripcion: "Ron colombiano añejado 8 años, sabor suave",
                proveedor: "Industrias Licoreras",
                ubicacion: "Estante D1"
            },
            {
                id: 5,
                nombre: "Cerveza Corona Extra",
                categoria: "cerveza",
                codigo_barras: "7501055303129",
                marca: "Corona",
                precio_costo: 4000,
                precio_venta: 5000,
                stock: 45,
                stock_minimo: 20,
                descripcion: "Cerveza lager mexicana, botella transparente",
                proveedor: "AB InBev",
                ubicacion: "Refrigerador 1"
            },
            {
                id: 6,
                nombre: "Tequila José Cuervo Especial",
                categoria: "tequila",
                codigo_barras: "7501035013409",
                marca: "José Cuervo",
                precio_costo: 28000,
                precio_venta: 35000,
                stock: 12,
                stock_minimo: 10,
                descripcion: "Tequila mixto gold, ideal para margaritas",
                proveedor: "Becle SAB",
                ubicacion: "Estante E2"
            }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            // ========== NAVEGACIÓN DEL SIDEBAR ==========
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const moduleId = this.getAttribute('data-module');
                    
                    switch(moduleId) {
                        case 'dashboard':
                            window.location.href = "{% url 'panel' %}";
                            break;
                        case 'inventory':
                            window.location.href = "{% url 'inventario' %}";
                            break;
                        case 'sales':
                            window.location.href = "{% url 'registro_v' %}";
                            break;
                        case 'reports':
                            window.location.href = "{% url 'reporte' %}";
                            break;
                        case 'products':
                            window.location.href = "{% url 'catalogo' %}";
                            break;
                    }
                });
            });

            // ========== VARIABLES GLOBALES ==========
            let productos = [...productosEjemplo];
            let editingProduct = null;
            let currentPage = 1;
            const productsPerPage = 6;
            let currentTab = 'basic';

            // ========== INICIALIZACIÓN ==========
            cargarProductos();
            actualizarEstadisticas();

            // ========== GESTIÓN DE VISTAS ==========
            const btnViews = document.querySelectorAll('.btn-view');
            btnViews.forEach(btn => {
                btn.addEventListener('click', function() {
                    const viewType = this.getAttribute('data-view');
                    btnViews.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.getElementById('view-grid').style.display = viewType === 'grid' ? 'grid' : 'none';
                    document.getElementById('view-table').style.display = viewType === 'table' ? 'block' : 'none';
                });
            });

            // ========== BÚSQUEDA Y FILTROS ==========
            document.getElementById('search-product').addEventListener('input', aplicarFiltros);
            document.getElementById('filter-status').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-sort').addEventListener('change', aplicarFiltros);
            document.getElementById('price-min').addEventListener('input', aplicarFiltros);
            document.getElementById('price-max').addEventListener('input', aplicarFiltros);

            // Filtros de categoría por botones
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    aplicarFiltros();
                });
            });

            // ========== MODAL DE PRODUCTO ==========
            const modal = document.getElementById('product-modal');
            const btnNuevoProducto = document.getElementById('btn-nuevo-producto');
            const btnCancelar = document.getElementById('btn-cancelar');
            const formProducto = document.getElementById('form-producto-data');

            btnNuevoProducto.addEventListener('click', () => abrirModal());
            btnCancelar.addEventListener('click', cerrarModal);

            // Navegación entre tabs del modal
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    cambiarTab(tabId);
                });
            });

            document.getElementById('btn-next-tab').addEventListener('click', siguienteTab);
            document.getElementById('btn-prev-tab').addEventListener('click', tabAnterior);

            // Cálculo de margen en tiempo real
            document.getElementById('product-cost').addEventListener('input', calcularMargen);
            document.getElementById('product-price').addEventListener('input', calcularMargen);

            // ========== FUNCIONES PRINCIPALES ==========
            function cargarProductos() {
                renderizarGrid();
                renderizarTabla();
            }

            function renderizarGrid() {
                const grid = document.getElementById('view-grid');
                const productosPaginados = obtenerProductosPaginados();
                
                grid.innerHTML = productosPaginados.map(producto => `
                    <div class="product-card" data-id="${producto.id}">
                        <div class="product-header">
                            <div class="product-badge badge-${producto.categoria}">
                                <i class="fas fa-${obtenerIconoCategoria(producto.categoria)}"></i>
                                ${producto.categoria.charAt(0).toUpperCase() + producto.categoria.slice(1)}
                            </div>
                            <div class="product-actions">
                                <button class="btn-icon btn-edit" data-id="${producto.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-delete" data-id="${producto.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-image ${producto.categoria}">
                            <i class="fas fa-${obtenerIconoCategoria(producto.categoria)}"></i>
                        </div>
                        <div class="product-info">
                            <h4 class="product-name">${producto.nombre}</h4>
                            <div class="product-meta">
                                <span class="product-brand">${producto.marca}</span>
                                <span class="product-code">${producto.codigo_barras}</span>
                            </div>
                            <div class="product-details">
                                <div class="price-section">
                                    <div class="price-display">
                                        <span class="price-sale">$${producto.precio_venta.toLocaleString()}</span>
                                        <span class="price-cost">$${producto.precio_costo.toLocaleString()}</span>
                                    </div>
                                    <div class="margin-badge ${calcularMargenClase(producto)}">
                                        ${calcularMargenPorcentaje(producto)}%
                                    </div>
                                </div>
                                <div class="stock-section">
                                    <div class="stock-info">
                                        <span class="stock-label">Stock:</span>
                                        <span class="stock-value ${obtenerClaseStock(producto)}">${producto.stock}</span>
                                        <span class="stock-min">/ Mín: ${producto.stock_minimo}</span>
                                    </div>
                                    <div class="stock-bar">
                                        <div class="stock-fill ${obtenerClaseStock(producto)}" 
                                             style="width: ${(producto.stock / (producto.stock_minimo * 2)) * 100}%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="product-footer">
                            <button class="btn btn-sm btn-stock" data-id="${producto.id}">
                                <i class="fas fa-plus"></i> Agregar Stock
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="venderProducto(${producto.id})">
                                <i class="fas fa-cash-register"></i> Vender
                            </button>
                        </div>
                    </div>
                `).join('');

                // Agregar event listeners a los botones
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        editarProducto(productId);
                    });
                });

                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        eliminarProducto(productId);
                    });
                });

                document.querySelectorAll('.btn-stock').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        agregarStock(productId);
                    });
                });
            }

            function renderizarTabla() {
                const tbody = document.getElementById('table-body');
                const productosPaginados = obtenerProductosPaginados();
                
                tbody.innerHTML = productosPaginados.map(producto => `
                    <tr data-id="${producto.id}">
                        <td>
                            <input type="checkbox" class="product-select" value="${producto.id}">
                        </td>
                        <td>
                            <div class="product-cell">
                                <div class="product-avatar ${producto.categoria}">
                                    <i class="fas fa-${obtenerIconoCategoria(producto.categoria)}"></i>
                                </div>
                                <div class="product-info-compact">
                                    <strong>${producto.nombre}</strong>
                                    <small>${producto.marca} • ${producto.codigo_barras}</small>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge badge-${producto.categoria}">${producto.categoria}</span></td>
                        <td>$${producto.precio_costo.toLocaleString()}</td>
                        <td><strong>$${producto.precio_venta.toLocaleString()}</strong></td>
                        <td>
                            <span class="margin-indicator ${calcularMargenClase(producto)}">
                                ${calcularMargenPorcentaje(producto)}%
                            </span>
                        </td>
                        <td>
                            <div class="stock-display">
                                <span class="stock-number ${obtenerClaseStock(producto)}">${producto.stock}</span>
                                <div class="stock-progress">
                                    <div class="progress-fill ${obtenerClaseStock(producto)}" 
                                         style="width: ${(producto.stock / (producto.stock_minimo * 2)) * 100}%">
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><span class="status ${obtenerClaseStock(producto)}">${obtenerEstadoStock(producto)}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon btn-edit" data-id="${producto.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-stock" data-id="${producto.id}">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn-icon btn-delete" data-id="${producto.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            // ... (resto del código JavaScript se mantiene similar pero adaptado a las nuevas funcionalidades)

            console.log('Catálogo de Productos LicoControl - Mejorado y cargado correctamente');
        });

        // ========== FUNCIONES GLOBALES ==========
        function navigateTo(url) {
            window.location.href = url;
        }

        function venderProducto(productId) {
            alert(`Función de venta rápida para producto ${productId}`);
            // Aquí podrías integrar con el módulo de ventas
        }

        function obtenerIconoCategoria(categoria) {
            const iconos = {
                'whisky': 'wine-bottle',
                'vino': 'wine-glass-alt',
                'vodka': 'cocktail',
                'ron': 'glass-whiskey',
                'cerveza': 'beer',
                'tequila': 'wine-bottle',
                'licor': 'wine-bottle'
            };
            return iconos[categoria] || 'wine-bottle';
        }
    </script>
</body>
</html>